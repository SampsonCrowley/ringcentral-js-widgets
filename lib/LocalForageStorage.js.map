{"version":3,"sources":["lib/LocalForageStorage.js"],"names":["LocalforageStorage","storageKey","Error","_storageKey","_storageSyncKey","_ready","_id","uuid","v4","localStorage","window","localforage","config","name","_localforage","createInstance","_tabSyncHandler","event","key","substring","length","JSON","parse","newValue","setter","id","getItem","value","emit","addEventListener","MemoryStorage","syncKey","setItem","stringify","timestamp","Date","now","keys","ready","output","getLocalStorageKeys","promises","map","then","data","Promise","all","originalData","undefined","_updateStorageSyncData","error","console","removeItem","removeEventListener","EventEmitter"],"mappings":"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","sourcesContent":["import uuid from 'uuid';\nimport EventEmitter from 'events';\nimport localforage from 'localforage';\n\nimport MemoryStorage from './MemoryStorage';\n\nexport default class LocalforageStorage extends EventEmitter {\n  constructor({\n    storageKey,\n  }) {\n    super();\n    if (!storageKey) {\n      throw Error('SynchronizedStorage must be created with a storage key');\n    }\n    this._storageKey = storageKey;\n    this._storageSyncKey = `${storageKey}-sync`;\n    this._ready = false;\n    this._id = uuid.v4();\n    if (typeof localStorage !== 'undefined' && typeof window !== 'undefined') {\n      localforage.config({ name: this._storageKey });\n      this._localforage = localforage.createInstance({\n        name: this._storageKey,\n      });\n      this._tabSyncHandler = async (event) => {\n        if (\n          event.key !== null &&\n          typeof event.key !== 'undefined' &&\n          event.key.substring(0, this._storageSyncKey.length) === this._storageSyncKey\n        ) {\n          try {\n            const { setter } = JSON.parse(event.newValue);\n            if (!setter || setter === this.id) {\n              return;\n            }\n            const key = event.key.substring(this._storageSyncKey.length + 1);\n            const value = await this.getItem(key);\n            this.emit('storage', {\n              key,\n              value,\n            });\n          } catch (e) {\n            /* ignore error */\n          }\n        }\n      };\n      window.addEventListener('storage', this._tabSyncHandler);\n    } else {\n      this._localforage = new MemoryStorage();\n    }\n  }\n\n  _updateStorageSyncData(key) {\n    if (typeof localStorage !== 'undefined') {\n      const syncKey = `${this._storageSyncKey}-${key}`;\n      localStorage.setItem(\n        syncKey,\n        JSON.stringify({\n          timestamp: Date.now(),\n          setter: this.id,\n        })\n      );\n    }\n  }\n\n  async getLocalStorageKeys() {\n    const keys = await this._localforage.keys();\n    return keys;\n  }\n\n  async getData() {\n    await this.ready();\n    const output = {};\n    const keys = await this.getLocalStorageKeys();\n    const promises = keys.map(key =>\n      this.getItem(key).then((data) => { output[key] = data; })\n    );\n    await Promise.all(promises);\n    return output;\n  }\n\n  async getItem(key) {\n    const originalData = await this._localforage.getItem(key);\n    try {\n      const { value } = originalData;\n      return value;\n    } catch (error) {\n      return undefined;\n    }\n  }\n\n  async setItem(key, value) {\n    await this._localforage.setItem(\n      key,\n      { value, setter: this.id },\n    );\n    try {\n      this._updateStorageSyncData(key);\n    } catch (error) {\n      console.error(error);\n    }\n  }\n\n  async removeItem(key) {\n    await this._localforage.removeItem(key);\n  }\n\n  destroy() {\n    if (this._tabSyncHandler) {\n      window.removeEventListener('storage', this._tabSyncHandler);\n    }\n  }\n\n  get id() {\n    return this._id;\n  }\n\n  async ready() {\n    if (this._ready) {\n      return;\n    }\n    if (typeof this._localforage.ready === 'function') {\n      await this._localforage.ready();\n    }\n    this._ready = true;\n  }\n}\n"],"file":"LocalForageStorage.js"}