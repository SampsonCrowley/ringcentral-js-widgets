{"version":3,"sources":["modules/Locale/index.js"],"names":["Locale","deps","dep","optional","defaultLocale","DEFAULT_LOCALE","detectBrowser","polling","pollingInterval","options","_defaultLocale","_detectBrowser","_polling","_pollingInterval","setLocale","browserLocale","store","dispatch","type","actionTypes","initSuccess","_syncBrowserLocale","debugMode","currentLocale","setTimeout","proxyInit","_setLocale","proxyInitSuccess","subscribe","state","proxyState","proxyLocale","syncProxyLocale","locale","toggleDebugMode","PSEUDO_LOCALE","I18n","formatMessage","setup","setLocaleSuccess","setLocaleError","error","Enum","Object","keys","moduleActionTypes","proxyActionTypes","status","_transport","RcModule","proxify"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AACA;;AACA;;AAIA;;AACA;;AACA;;AACA;;AAKA;;AACA;;AACA;;AACA;;AACA;;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IASqBA,M;AAPrB;;;;OAIC,gBAAO;AACNC,EAAAA,IAAI,EAAE,CAAC;AAAEC,IAAAA,GAAG,EAAE,eAAP;AAAwBC,IAAAA,QAAQ,EAAE;AAAlC,GAAD;AADA,CAAP,C;;;;;AAIC;;;;;AAKA,oBAMQ;AAAA;;AAAA,mFAAJ,EAAI;;AAAA,kCALNC,aAKM;AAAA,QALNA,aAKM,mCALUC,oBAKV;AAAA,kCAJNC,aAIM;AAAA,QAJNA,aAIM,mCAJU,IAIV;AAAA,4BAHNC,OAGM;AAAA,QAHNA,OAGM,6BAHI,KAGJ;AAAA,oCAFNC,eAEM;AAAA,QAFNA,eAEM,qCAFY,IAEZ;AAAA,QADHC,OACG;;AAAA;;AACN,kGACKA,OADL;AAGA,UAAKC,cAAL,GAAsBN,aAAtB;AACA,UAAKO,cAAL,GAAsBL,aAAtB;AACA,UAAKM,QAAL,GAAgBL,OAAhB;AACA,UAAKM,gBAAL,GAAwBL,eAAxB;AAPM;AAQP;;;;;;;;;;;;;uBA8BO,KAAKM,SAAL,CACJ,KAAKH,cAAL,GACE,KAAKI,aADP,GAEE,KAAKL,cAHH,C;;;AAKN,qBAAKM,KAAL,CAAWC,QAAX,CAAoB;AAClBC,kBAAAA,IAAI,EAAE,KAAKC,WAAL,CAAiBC;AADL,iBAApB;;AAGA,oBAAI,KAAKR,QAAT,EAAmB;AACjB,uBAAKS,kBAAL;AACD;;;;;;;;;;;;;;;;;;;;;;;;;;;;sBAIG,CAAC,KAAKC,SAAN,IAAmB,KAAKP,aAAL,KAAuB,KAAKQ,a;;;;;;uBAC3C,KAAKT,SAAL,CAAe,KAAKC,aAApB,C;;;AAERS,gBAAAA,UAAU,CAAC;AAAA,yBAAM,MAAI,CAACH,kBAAL,EAAN;AAAA,iBAAD,EAAkC,KAAKR,gBAAvC,CAAV;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAIA,qBAAKG,KAAL,CAAWC,QAAX,CAAoB;AAClBC,kBAAAA,IAAI,EAAE,KAAKC,WAAL,CAAiBM;AADL,iBAApB;;uBAGM,KAAKC,UAAL,CAAgB,KAAKH,aAArB,C;;;AACN,qBAAKP,KAAL,CAAWC,QAAX,CAAoB;AAClBC,kBAAAA,IAAI,EAAE,KAAKC,WAAL,CAAiBQ;AADL,iBAApB;AAGA,qBAAKX,KAAL,CAAWY,SAAX;AAAA;AAAA;AAAA;AAAA,wCAAqB;AAAA;AAAA;AAAA;AAAA;AAAA,gCACf,MAAI,CAACC,KAAL,CAAWN,aAAX,KAA6B,MAAI,CAACO,UAAL,CAAgBC,WAD9B;AAAA;AAAA;AAAA;;AAAA;AAAA,iCAEX,MAAI,CAACL,UAAL,CAAgB,MAAI,CAACG,KAAL,CAAWN,aAA3B,CAFW;;AAAA;AAGjB,0BAAA,MAAI,CAACP,KAAL,CAAWC,QAAX,CAAoB;AAClBC,4BAAAA,IAAI,EAAE,MAAI,CAACC,WAAL,CAAiBa,eADL;AAElBC,4BAAAA,MAAM,EAAE,MAAI,CAACJ,KAAL,CAAWN;AAFD,2BAApB;;AAHiB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,iBAArB;;;;;;;;;;;;;;;;AAWF;;;;;;;;;;;;;;AAiCE,qBAAKP,KAAL,CAAWC,QAAX,CAAoB;AAClBC,kBAAAA,IAAI,EAAE,KAAKC,WAAL,CAAiBe,eADL;AAElBZ,kBAAAA,SAAS,EAAE,KAAKA;AAFE,iBAApB;;AAIA,oBAAI,KAAKA,SAAT,EAAoB;AAClB,uBAAKR,SAAL,CAAeqB,mBAAf;AACD;;;;;;;;;;;;;;;;;;;;;gDAGcF,M;;;;;;uBACTG,iBAAKtB,SAAL,CAAemB,MAAf,C;;;AACNI,0CAAcC,KAAd,CAAoB;AAClBL,kBAAAA,MAAM,EAAE,KAAKV,aAAL,KAAuBY,mBAAvB,GAAuC9B,oBAAvC,GAAwD,KAAKkB;AADnD,iBAApB;;;;;;;;;;;;;;;;AAKF;;;;;;;;;;;;;;gDASgBU,M;;;;;AACd,qBAAKjB,KAAL,CAAWC,QAAX,CAAoB;AAClBC,kBAAAA,IAAI,EAAE,KAAKC,WAAL,CAAiBL,SADL;AAElBmB,kBAAAA,MAAM,EAANA;AAFkB,iBAApB;;;uBAKQ,KAAKP,UAAL,CAAgBO,MAAhB,C;;;AACN,qBAAKjB,KAAL,CAAWC,QAAX,CAAoB;AAClBC,kBAAAA,IAAI,EAAE,KAAKC,WAAL,CAAiBoB,gBADL;AAElBN,kBAAAA,MAAM,EAANA;AAFkB,iBAApB;;;;;;;AAKA,qBAAKjB,KAAL,CAAWC,QAAX,CAAoB;AAClBC,kBAAAA,IAAI,EAAE,KAAKC,WAAL,CAAiBqB,cADL;AAElBC,kBAAAA,KAAK;AAFa,iBAApB;;;;;;;;;;;;;;;;;;wBAzIe;AACjB,aAAO,IAAIC,gBAAJ,8BACFC,MAAM,CAACC,IAAP,CAAYC,oCAAZ,CADE,sBAEFF,MAAM,CAACC,IAAP,CAAYE,4BAAZ,CAFE,IAGL,WAHK,EAIL,kBAJK,EAKL,gBALK,EAML,iBANK,EAOL,iBAPK,IAQJ,QARI,CAAP;AASD;;;wBAEa;AACZ,aAAO,4BAAgB;AACrBC,QAAAA,MAAM,EAAE,wCAAuB,KAAK5B,WAA5B,CADa;AAErBI,QAAAA,aAAa,EAAE,uCAAwB,KAAKJ,WAA7B,CAFM;AAGrBG,QAAAA,SAAS,EAAE,kCAAmB,KAAKH,WAAxB;AAHU,OAAhB,CAAP;AAKD;;;wBAEkB;AACjB,aAAO,4BAAgB;AACrB4B,QAAAA,MAAM,EAAE,uCAAsB,KAAK5B,WAA3B,CADa;AAErBY,QAAAA,WAAW,EAAE,qCAAsB,KAAKZ,WAA3B;AAFQ,OAAhB,CAAP;AAID;;;wBA6CmB;AAClB,aAEI,KAAK6B,UAAL,IACA,KAAKlB,UADL,KAEC,KAAKA,UAAL,CAAgBC,WAAhB,IAA+B,KAAKrB,cAFrC,CADF,IAKA,KAAKmB,KAAL,CAAWN,aALX,IAMA,KAAKb,cAPP;AASD;;;wBAEmB;AAClB,aAAO,qCAAoB,KAAKA,cAAzB,CAAP;AACD;;;wBAEY;AACX,aAAQ,KAAKoB,UAAL,IAAmB,KAAKA,UAAL,CAAgBiB,MAApC,IAA+C,KAAKlB,KAAL,CAAWkB,MAAjE;AACD;;;wBAEiB;AAChB,aAAO,KAAKjB,UAAL,CAAgBiB,MAAvB;AACD;;;wBAEe;AACd,aAAO,KAAKlB,KAAL,CAAWP,SAAlB;AACD;;;;EAtHiC2B,qB,qEAwHjCC,mB,yJA0BAA,mB","sourcesContent":["import formatMessage from 'format-message';\nimport { combineReducers } from 'redux';\nimport I18n, {\n  DEFAULT_LOCALE,\n  PSEUDO_LOCALE,\n} from '@ringcentral-integration/i18n';\nimport RcModule from '../../lib/RcModule';\nimport proxify from '../../lib/proxy/proxify';\nimport { Module } from '../../lib/di';\nimport {\n  getCurrentLocaleReducer,\n  getProxyLocaleReducer,\n  getToggleDebugMode\n} from './reducers';\nimport getModuleStatusReducer from '../../lib/getModuleStatusReducer';\nimport getProxyStatusReducer from '../../lib/getProxyStatusReducer';\nimport detectBrowserLocale from '../../lib/detectBrowserLocale';\nimport Enum from '../../lib/Enum';\nimport { moduleActionTypes } from '../../enums/moduleActionTypes';\nimport proxyActionTypes from '../../enums/proxyActionTypes';\n\n/**\n * @class\n * @description Locale managing module\n */\n@Module({\n  deps: [{ dep: 'LocaleOptions', optional: true }]\n})\nexport default class Locale extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {String} params.defaultLocale - default 'en-US'\n   */\n  constructor({\n    defaultLocale = DEFAULT_LOCALE,\n    detectBrowser = true,\n    polling = false,\n    pollingInterval = 2000,\n    ...options\n  } = {}) {\n    super({\n      ...options,\n    });\n    this._defaultLocale = defaultLocale;\n    this._detectBrowser = detectBrowser;\n    this._polling = polling;\n    this._pollingInterval = pollingInterval;\n  }\n\n  get _actionTypes() {\n    return new Enum([\n      ...Object.keys(moduleActionTypes),\n      ...Object.keys(proxyActionTypes),\n      'setLocale',\n      'setLocaleSuccess',\n      'setLocaleError',\n      'syncProxyLocale',\n      'toggleDebugMode',\n    ], 'locale');\n  }\n\n  get reducer() {\n    return combineReducers({\n      status: getModuleStatusReducer(this.actionTypes),\n      currentLocale: getCurrentLocaleReducer(this.actionTypes),\n      debugMode: getToggleDebugMode(this.actionTypes),\n    });\n  }\n\n  get proxyReducer() {\n    return combineReducers({\n      status: getProxyStatusReducer(this.actionTypes),\n      proxyLocale: getProxyLocaleReducer(this.actionTypes),\n    });\n  }\n\n  async initialize() {\n    await this.setLocale(\n      this._detectBrowser ?\n        this.browserLocale :\n        this._defaultLocale\n    );\n    this.store.dispatch({\n      type: this.actionTypes.initSuccess,\n    });\n    if (this._polling) {\n      this._syncBrowserLocale();\n    }\n  }\n\n  async _syncBrowserLocale() {\n    if (!this.debugMode && this.browserLocale !== this.currentLocale) {\n      await this.setLocale(this.browserLocale);\n    }\n    setTimeout(() => this._syncBrowserLocale(), this._pollingInterval);\n  }\n\n  async initializeProxy() {\n    this.store.dispatch({\n      type: this.actionTypes.proxyInit,\n    });\n    await this._setLocale(this.currentLocale);\n    this.store.dispatch({\n      type: this.actionTypes.proxyInitSuccess,\n    });\n    this.store.subscribe(async () => {\n      if (this.state.currentLocale !== this.proxyState.proxyLocale) {\n        await this._setLocale(this.state.currentLocale);\n        this.store.dispatch({\n          type: this.actionTypes.syncProxyLocale,\n          locale: this.state.currentLocale,\n        });\n      }\n    });\n  }\n\n  /**\n   * @property {String} currentLocale\n   */\n  get currentLocale() {\n    return (\n      (\n        this._transport &&\n        this.proxyState &&\n        (this.proxyState.proxyLocale || this._defaultLocale)\n      ) ||\n      this.state.currentLocale ||\n      this._defaultLocale\n    );\n  }\n\n  get browserLocale() {\n    return detectBrowserLocale(this._defaultLocale);\n  }\n\n  get status() {\n    return (this.proxyState && this.proxyState.status) || this.state.status;\n  }\n\n  get proxyStatus() {\n    return this.proxyState.status;\n  }\n\n  get debugMode() {\n    return this.state.debugMode;\n  }\n\n  @proxify\n  async toggleDebugMode() {\n    this.store.dispatch({\n      type: this.actionTypes.toggleDebugMode,\n      debugMode: this.debugMode,\n    });\n    if (this.debugMode) {\n      this.setLocale(PSEUDO_LOCALE);\n    }\n  }\n\n  async _setLocale(locale) {\n    await I18n.setLocale(locale);\n    formatMessage.setup({\n      locale: this.currentLocale === PSEUDO_LOCALE ? DEFAULT_LOCALE : this.currentLocale,\n    });\n  }\n\n  /**\n   *  @function\n   *  @description Sets the desired locale as the current locale. This will also\n   *    set all I18n instances to the same locale, as well as set formatMessage to use\n   *    the same locale.\n   *  @param {String} locale\n   *  @return {Promise}\n   */\n  @proxify\n  async setLocale(locale) {\n    this.store.dispatch({\n      type: this.actionTypes.setLocale,\n      locale,\n    });\n    try {\n      await this._setLocale(locale);\n      this.store.dispatch({\n        type: this.actionTypes.setLocaleSuccess,\n        locale,\n      });\n    } catch (error) {\n      this.store.dispatch({\n        type: this.actionTypes.setLocaleError,\n        error,\n      });\n    }\n  }\n}\n"],"file":"index.js"}