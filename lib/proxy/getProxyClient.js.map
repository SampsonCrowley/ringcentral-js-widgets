{"version":3,"sources":["lib/proxy/getProxyClient.js"],"names":["getProxyClient","createTarget","transport","options","actionTypes","baseActionTypes","_id","uuid","v4","_target","_getState","state","target","_getProxyState","proxy","_transport","ensureExist","_setTransport","subModule","Object","prototype","hasOwnProperty","RcModule","defineProperty","configurable","enumerable","get","_reducer","targetReducer","reducer","proxyReducer","types","_proxyActionTypes","_suppressInit","request","payload","type","sync","actionNumber","result","store","dispatch","_syncPromise","_sync","initializeProxy","_proxyInitialized","_initialize","on","events","push","action"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGe,SAASA,cAAT,CAAwBC,YAAxB,EAAsC;AACnD;AAAA;AAAA;AAAA;;AACE,4BAAuC;AAAA;;AAAA;;AAAA,YAAzBC,SAAyB,QAAzBA,SAAyB;AAAA,YAAXC,OAAW;;AAAA;;AACrC,sGACKA,OADL;AAEEC,UAAAA,WAAW,EAAEC;AAFf;AAIA,cAAKC,GAAL,GAAWC,iBAAKC,EAAL,EAAX;AACA,cAAKC,OAAL,GAAeR,YAAY,mBACtBE,OADsB,EAA3B;;AAGA,cAAKM,OAAL,CAAaC,SAAb,GAAyB;AAAA,iBAAM,MAAKC,KAAL,CAAWC,MAAjB;AAAA,SAAzB;;AACA,cAAKH,OAAL,CAAaI,cAAb,GAA8B;AAAA,iBAAM,MAAKF,KAAL,CAAWG,KAAjB;AAAA,SAA9B,CAVqC,CAWrC;AACA;AACA;AACA;AACA;;;AACA,cAAKC,UAAL,GAAkB,2CAAMC,uBAAN,iBAAkBd,SAAlB,EAA6B,WAA7B,CAAlB;;AACA,cAAKe,aAAL,CAAmB,MAAKR,OAAxB;;AAjBqC,mCAkB1BS,SAlB0B;AAAA;;AAmBnC,cACE,mBAAKT,OAAL,EAAcU,MAAM,CAACC,SAAP,CAAiBC,cAA/B,kBAA8CH,SAA9C,KACE,MAAKT,OAAL,CAAaS,SAAb,aAAmCI,qBAFvC,EAGE;AACAH,YAAAA,MAAM,CAACI,cAAP,gCAA4BL,SAA5B,EAAuC;AACrCM,cAAAA,YAAY,EAAE,KADuB;AAErCC,cAAAA,UAAU,EAAE,IAFyB;AAGrCC,cAAAA,GAHqC,iBAG/B;AACJ,uBAAO,KAAKjB,OAAL,CAAaS,SAAb,CAAP;AACD;AALoC,aAAvC;AAOD;AA9BkC;;AAkBrC,aAAK,IAAMA,SAAX,IAAwB,MAAKT,OAA7B,EAAsC;AAAA,gBAA3BS,SAA2B;AAarC;;AAED,cAAKS,QAAL,GAAgB,uCAAsB;AACpCC,UAAAA,aAAa,EAAE,MAAKnB,OAAL,CAAaoB,OADQ;AAEpCC,UAAAA,YAAY,EAAE,MAAKrB,OAAL,CAAaqB,YAFS;AAGpC5B,UAAAA,SAAS,EAATA,SAHoC;AAIpC6B,UAAAA,KAAK,EAAE,MAAK3B;AAJwB,SAAtB,CAAhB;AAjCqC;AAuCtC;;AAxCH;AAAA;AAAA,sCA0CgBQ,MA1ChB,EA0CwB;AACpBA,UAAAA,MAAM,CAACG,UAAP,GAAoB,KAAKA,UAAzB;AACAH,UAAAA,MAAM,CAACoB,iBAAP,GAA2B,KAAK5B,WAAhC;AACAQ,UAAAA,MAAM,CAACqB,aAAP,GAAuB,IAAvB;;AACA,eAAK,IAAMf,SAAX,IAAwBN,MAAxB,EAAgC;AAC9B,gBACUO,MAAM,CAACC,SAAP,CAAiBC,cAAzB,MAAAT,MAAM,EAAkCM,SAAlC,CAAN,IACEN,MAAM,CAACM,SAAD,CAAN,YAA6BI,qBAFjC,EAGE;AACA,mBAAKL,aAAL,CAAmBL,MAAM,CAACM,SAAD,CAAzB;AACD;AACF;AACF;AAtDH;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,2BA2D2B,KAAKH,UAAL,CAAgBmB,OAAhB,CAAwB;AAC3CC,sBAAAA,OAAO,EAAE;AACPC,wBAAAA,IAAI,EAAE,KAAKhC,WAAL,CAAiBiC,IADhB;AAEPC,wBAAAA,YAAY,EAAE,KAAK3B,KAAL,CAAW2B;AAFlB;AADkC,qBAAxB,CA3D3B;;AAAA;AA2DYC,oBAAAA,MA3DZ;AAiEM,yBAAKC,KAAL,CAAWC,QAAX,mBACKF,MADL;AAEEH,sBAAAA,IAAI,EAAE,KAAKhC,WAAL,CAAiBiC;AAFzB;AAjEN;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAsEI,yBAAKK,YAAL,GAAoB,IAApB;;AAtEJ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,+BAwES;AACL,cAAI,CAAC,KAAKA,YAAV,EAAwB;AACtB,iBAAKA,YAAL,GAAoB,KAAKC,KAAL,EAApB;AACD;;AACD,iBAAO,KAAKD,YAAZ;AACD;AA7EH;AAAA;AAAA,oCA+Ec9B,MA/Ed,EA+EsB;AAClB,cACE,OAAOA,MAAM,CAACgC,eAAd,KAAkC,UAAlC,IACA,CAAChC,MAAM,CAACiC,iBAFV,EAGE;AACAjC,YAAAA,MAAM,CAACiC,iBAAP,GAA2B,IAA3B;AACAjC,YAAAA,MAAM,CAACgC,eAAP;AACD;;AACD,eAAK,IAAM1B,SAAX,IAAwBN,MAAxB,EAAgC;AAC9B,gBACUO,MAAM,CAACC,SAAP,CAAiBC,cAAzB,MAAAT,MAAM,EAAkCM,SAAlC,CAAN,IACEN,MAAM,CAACM,SAAD,CAAN,YAA6BI,qBAFjC,EAGE;AACA,mBAAKwB,WAAL,CAAiBlC,MAAM,CAACM,SAAD,CAAvB;AACD;AACF;AACF;AA/FH;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAiGI;AACA;AACA,yBAAK4B,WAAL,CAAiB,KAAKrC,OAAtB;;AACA,yBAAKM,UAAL,CAAgBgC,EAAhB,CAAmB,KAAKhC,UAAL,CAAgBiC,MAAhB,CAAuBC,IAA1C;AAAA;AAAA;AAAA;AAAA;AAAA,8CAAgD,kBAAOd,OAAP;AAAA;AAAA;AAAA;AAAA;AAAA,sCAC1CA,OAAO,CAACC,IAAR,KAAiB,MAAI,CAAChC,WAAL,CAAiB8C,MADQ;AAAA;AAAA;AAAA;;AAAA,qCAExC,MAAI,CAACR,YAFmC;AAAA;AAAA;AAAA;;AAAA;AAAA,uCAEf,MAAI,CAACA,YAFU;;AAAA;AAAA,sCAGxCP,OAAO,CAACG,YAAR,KAAyB,MAAI,CAAC3B,KAAL,CAAW2B,YAAX,GAA0B,CAHX;AAAA;AAAA;AAAA;;AAI1C,gCAAA,MAAI,CAACE,KAAL,CAAWC,QAAX,mBACKN,OADL;AAEEC,kCAAAA,IAAI,EAAE,MAAI,CAAChC,WAAL,CAAiB8C;AAFzB;;AAJ0C;AAAA;;AAAA;AAAA;AAAA,uCASpC,MAAI,CAACb,IAAL,EAToC;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uBAAhD;;AAAA;AAAA;AAAA;AAAA;;AApGJ;AAAA,2BAiHU,KAAKA,IAAL,EAjHV;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA,MAAqBf,qBAArB;AAAA;AAoHD","sourcesContent":["import uuid from 'uuid';\nimport RcModule from '../RcModule';\nimport getProxyClientReducer from './getProxyClientReducer';\nimport baseActionTypes from './baseActionTypes';\nimport ensureExist from '../ensureExist';\n\n\nexport default function getProxyClient(createTarget) {\n  return class extends RcModule {\n    constructor({ transport, ...options }) {\n      super({\n        ...options,\n        actionTypes: baseActionTypes,\n      });\n      this._id = uuid.v4();\n      this._target = createTarget({\n        ...options,\n      });\n      this._target._getState = () => this.state.target;\n      this._target._getProxyState = () => this.state.proxy;\n      // this._target = new Target({\n      //   ...options,\n      //   getState: () => this.state.target,\n      //   getProxyState: () => this.state.proxy,\n      // });\n      this._transport = this::ensureExist(transport, 'transport');\n      this._setTransport(this._target);\n      for (const subModule in this._target) {\n        if (\n          this._target::Object.prototype.hasOwnProperty(subModule) &&\n            this._target[subModule] instanceof RcModule\n        ) {\n          Object.defineProperty(this, subModule, {\n            configurable: false,\n            enumerable: true,\n            get() {\n              return this._target[subModule];\n            },\n          });\n        }\n      }\n\n      this._reducer = getProxyClientReducer({\n        targetReducer: this._target.reducer,\n        proxyReducer: this._target.proxyReducer,\n        transport,\n        types: this.actionTypes,\n      });\n    }\n\n    _setTransport(target) {\n      target._transport = this._transport;\n      target._proxyActionTypes = this.actionTypes;\n      target._suppressInit = true;\n      for (const subModule in target) {\n        if (\n          target::Object.prototype.hasOwnProperty(subModule) &&\n            target[subModule] instanceof RcModule\n        ) {\n          this._setTransport(target[subModule]);\n        }\n      }\n    }\n\n\n    async _sync() {\n      try {\n        const result = await this._transport.request({\n          payload: {\n            type: this.actionTypes.sync,\n            actionNumber: this.state.actionNumber\n          },\n        });\n        this.store.dispatch({\n          ...result,\n          type: this.actionTypes.sync,\n        });\n      } catch (_) { /* Ignore */ }\n      this._syncPromise = null;\n    }\n    sync() {\n      if (!this._syncPromise) {\n        this._syncPromise = this._sync();\n      }\n      return this._syncPromise;\n    }\n\n    _initialize(target) {\n      if (\n        typeof target.initializeProxy === 'function' &&\n        !target._proxyInitialized\n      ) {\n        target._proxyInitialized = true;\n        target.initializeProxy();\n      }\n      for (const subModule in target) {\n        if (\n          target::Object.prototype.hasOwnProperty(subModule) &&\n            target[subModule] instanceof RcModule\n        ) {\n          this._initialize(target[subModule]);\n        }\n      }\n    }\n    async initialize() {\n      // initialize the instance before sync to avoid history object from\n      // becoming out of sync\n      this._initialize(this._target);\n      this._transport.on(this._transport.events.push, async (payload) => {\n        if (payload.type === this.actionTypes.action) {\n          if (this._syncPromise) await this._syncPromise;\n          if (payload.actionNumber === this.state.actionNumber + 1) {\n            this.store.dispatch({\n              ...payload,\n              type: this.actionTypes.action,\n            });\n          } else {\n            await this.sync();\n          }\n        }\n      });\n      await this.sync();\n    }\n  };\n}\n"],"file":"getProxyClient.js"}