{"version":3,"sources":["modules/ConferenceCall/index.js"],"names":["DEFAULT_TIMEOUT","DEFAULT_TTL","MAXIMUM_CAPACITY","_fromSessionId","_lastCallInfo","ascendSortParties","parties","filter","party","conferenceRole","toLowerCase","host","sort","last","next","id","split","ConferenceCall","deps","dep","optional","auth","alert","call","callingSettings","client","rolesAndPermissions","contactMatcher","webphone","connectivityMonitor","availabilityMonitor","pulling","capacity","timeout","options","actionTypes","_eventEmitter","EventEmitter","_auth","ensureExist","_alert","_call","_availabilityMonitor","_callingSettings","_client","_webphone","_connectivityMonitor","_contactMatcher","_rolesAndPermissions","_reducer","_ttl","_timout","_timers","_pulling","sessionId","res","findConferenceWithSession","isMerging","session","sessions","find","Object","values","conferences","c","store","dispatch","type","updateConference","conference","state","service","platform","get","rawResponse","response","json","storedconference","assign","updateConferenceSucceeded","updateConferenceFailed","message","toString","terminateConference","conferenceData","hangup","terminateConferenceSucceeded","terminateConferenceFailed","checkIfHAError","warning","conferenceCallErrors","webphoneSession","propagete","conferenceState","ready","isOverload","connectivity","danger","modeError","ttl","bringInConference","partyProfile","_getProfile","post","partyData","updateConferenceStatus","newConference","newParties","length","bringInConferenceSucceeded","bringInConferenceFailed","partyId","removeFromConference","removeFromConferenceSucceeded","removeFromConferenceFailed","propagate","_checkPermission","permissionsMessages","insufficientPrivilege","callingMode","callingModes","_makeConference","subscribe","_onStateChange","webphoneSessions","isConferenceSession","bringInFailed","mergeStart","conferenceId","sipInstances","map","_sessions","sessionIds","x","setSessionCaching","pSips","instance","p","Promise","resolve","on","all","_mergeToConference","then","mergeSucceeded","emit","profiles","mergeFailed","clearSessionCaching","fromSessionId","toSessionId","updateFromSession","updateToSession","mergingPair","closeMergingPair","reduce","accum","idx","status","code","partyStatusCode","disconnected","push","i","getOnlineParties","Array","isArray","countOnlineParties","setTimeout","stopPollingConferenceStatus","startPollingConferenceStatus","clearTimeout","Error","func","isOnce","once","off","updateCurrentConferenceId","initSuccess","_shouldInit","_init","_shouldReset","_reset","resetSuccess","loggedIn","pending","hasConferenceCallPermission","forEach","evt","bringInToConference","makeConference","confereceAccepted","race","reject","sipSession","phoneNumber","voiceCallToken","isConference","prototype","_hookConference","makeConferenceSucceeded","makeConferenceFailed","rcId","avatarUrl","calleeType","calleeTypes","unknown","partyName","direction","callDirections","outbound","toUserName","fromUserName","partyNumber","to","from","matchedContact","contactMatch","nameMatches","dataMapping","profileImageUrl","name","contacts","sessionIdToMergeWith","sessionToMergeWith","validateCallRecording","conferenceSession","setMergeParty","mergeToConference","resume","currentConferenceSession","isCurrentConferenceOnhold","isOnHold","callIsRecording","participantListClickHangupTrack","removeParticipantClickCancelTrack","removeParticipantClickRemoveTrack","conferenceCallStatus","currentConferenceId","RcModule","proxify","selector","partyProfiles","sessionName","sessionNumber","sessionStatus","fromSession","callStatus","lastCalleeType","sessionStatusEnum","finished","partiesAvatarUrls","profile","extraNum","lastCallContact","getOnlinePartyProfiles"],"mappings":"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","sourcesContent":["import { find } from 'ramda';\nimport EventEmitter from 'events';\nimport { Module } from '../../lib/di';\nimport RcModule from '../../lib/RcModule';\nimport proxify from '../../lib/proxy/proxify';\nimport ensureExist from '../../lib/ensureExist';\nimport calleeTypes from '../../enums/calleeTypes';\nimport callDirections from '../../enums/callDirections';\nimport { selector } from '../../lib/selector';\n\nimport callingModes from '../CallingSettings/callingModes';\nimport permissionsMessages from '../RolesAndPermissions/permissionsMessages';\nimport { isConferenceSession, isRecording } from '../Webphone/webphoneHelper';\nimport sessionStatusEnum from '../Webphone/sessionStatus';\n\nimport actionTypes from './actionTypes';\nimport conferenceRole from './conferenceRole';\nimport partyStatusCode from './partyStatusCode';\nimport conferenceCallErrors from './conferenceCallErrors';\nimport getConferenceCallReducer from './getConferenceCallReducer';\n\nconst DEFAULT_TIMEOUT = 30000;// time out for conferencing session being accepted.\nconst DEFAULT_TTL = 5000;// timer to update the conference information\nconst MAXIMUM_CAPACITY = 10;\n\nlet _fromSessionId;\nlet _lastCallInfo;\n\nfunction ascendSortParties(parties) {\n  return parties\n    .filter(party => party.conferenceRole.toLowerCase() !== conferenceRole.host)\n    .sort((last, next) => +last.id.split('-')[1] - (+next.id.split('-')[1]));\n}\n\n/**\n * @class\n * @description ConferenceCall managing module\n */\n@Module({\n  deps: [\n    'Auth',\n    'Alert',\n    'Call',\n    'CallingSettings',\n    'ConnectivityMonitor',\n    'Client',\n    'Webphone',\n    'RolesAndPermissions',\n    {\n      dep: 'ContactMatcher',\n      optional: true\n    },\n    {\n      dep: 'Webphone',\n      optional: true\n    },\n    {\n      dep: 'ConferenceCallOptions',\n      optional: true\n    },\n    {\n      dep: 'AvailabilityMonitor',\n      optional: true\n    },\n  ]\n})\n\nexport default class ConferenceCall extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {RegionSettings} params.regionSettings - regionSettings module instance\n   * @param {Client} params.client - client module instance\n   */\n  constructor({\n    auth,\n    alert,\n    call,\n    callingSettings,\n    client,\n    rolesAndPermissions,\n    contactMatcher,\n    webphone,\n    connectivityMonitor,\n    availabilityMonitor,\n    pulling = true,\n    capacity = MAXIMUM_CAPACITY,\n    timeout = DEFAULT_TIMEOUT,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._eventEmitter = new EventEmitter();\n    this._auth = this::ensureExist(auth, 'auth');\n    this._alert = this::ensureExist(alert, 'alert');\n    this._call = this::ensureExist(call, 'call');\n    this._availabilityMonitor = availabilityMonitor;\n    this._callingSettings = this::ensureExist(callingSettings, 'callingSettings');\n    this._client = this:: ensureExist(client, 'client');\n    // in order to run the integeration test, we need it to be optional\n    this._webphone = webphone;\n    this._connectivityMonitor = connectivityMonitor;\n    this._contactMatcher = contactMatcher;\n    this._rolesAndPermissions = this::ensureExist(rolesAndPermissions, 'rolesAndPermissions');\n    // we need the constructed actions\n    this._reducer = getConferenceCallReducer(this.actionTypes);\n    this._ttl = DEFAULT_TTL;\n    this._timout = timeout;\n    this._timers = {};\n    this._pulling = pulling;\n    this.capacity = capacity;\n  }\n\n  isConferenceSession(sessionId) {\n    // only can be used after webphone._onCallStartFunc\n    let res = !!this.findConferenceWithSession(sessionId);\n\n    if (this.isMerging && !res) {\n      const session = this._webphone.sessions.find(session => session.id === sessionId);\n      res = isConferenceSession(session);\n    }\n\n    return res;\n  }\n\n  findConferenceWithSession(sessionId) {\n    return Object.values(this.conferences).find(c => c.sessionId === sessionId);\n  }\n\n  /**\n   *\n   * @param {string} id: conference id\n   */\n  @proxify\n  async updateConferenceStatus(id) {\n    this.store.dispatch({\n      type: this.actionTypes.updateConference,\n      conference: this.state.conferences[id],\n    });\n    try {\n      const rawResponse = await this._client.service.platform()\n        .get(`/account/~/telephony/sessions/${id}`);\n      const response = rawResponse.json();\n      const storedconference = this.state.conferences[response.id];\n      const conference = Object.assign({}, storedconference.conference);\n      conference.parties = response.parties;\n      const {\n        sessionId\n      } = storedconference;\n      this.store.dispatch({\n        type: this.actionTypes.updateConferenceSucceeded,\n        conference,\n        sessionId,\n      });\n    } catch (e) {\n      // TODO: alert\n      this.store.dispatch({\n        type: this.actionTypes.updateConferenceFailed,\n        conference: this.state.conferences[id],\n        message: e.toString()\n      });\n      // need to propagate to out side try...catch block\n      throw e;\n    } finally {\n      // eslint-disable-next-line no-unsafe-finally\n      return this.state.conferences[id];\n    }\n  }\n\n  /**\n   * terminate a conference.\n   * @param {string} id: conference id\n   */\n  @proxify\n  async terminateConference(id) {\n    this.store.dispatch({\n      type: this.actionTypes.terminateConference,\n      conference: this.state.conferences[id],\n    });\n    const conferenceData = this.conferences[id];\n\n    try {\n      if (this._webphone) {\n        if (conferenceData) {\n          this._webphone.hangup(conferenceData.sessionId);\n          // Help server to do the GC, and we don't care the whether it's successful or not\n          this._client.service.platform()\n            .delete(`/account/~/telephony/sessions/${id}`);\n          this.store.dispatch({\n            type: this.actionTypes.terminateConferenceSucceeded,\n            conference: conferenceData.conference,\n          });\n        } else {\n          this.store.dispatch({\n            type: this.actionTypes.terminateConferenceFailed,\n          });\n        }\n      } else {\n        await this._client.service.platform()\n          .delete(`/account/~/telephony/sessions/${id}`);\n        this.store.dispatch({\n          type: this.actionTypes.terminateConferenceSucceeded,\n          conference: conferenceData.conference,\n        });\n      }\n    } catch (e) {\n      if (!this._availabilityMonitor || !this._availabilityMonitor.checkIfHAError(e)) {\n        this._alert.warning({\n          message: conferenceCallErrors.terminateConferenceFailed,\n        });\n      }\n\n      this.store.dispatch({\n        type: this.actionTypes.terminateConferenceFailed,\n        message: e.toString()\n      });\n    } finally {\n      // eslint-disable-next-line no-unsafe-finally\n      return conferenceData;\n    }\n  }\n\n  /**\n   * Bring-in an outbound call into conference.\n   * @param {string} id: conference id\n   * @param {webphone.session} webphoneSession: get it from callMonitor.\\w+Calls[\\d+]\n   * interface SessionData{\n   *  \"party-id\": String,\n   *  \"session-id\": String\n   * }\n   */\n  @proxify\n  async bringInToConference(id, webphoneSession, propagete = false) {\n    const conferenceState = this.state.conferences[id];\n    if (\n      !conferenceState\n      || !this.ready\n      || !webphoneSession\n      || this.isOverload(id)\n      || !this._connectivityMonitor.connectivity\n    ) {\n      this._alert.danger({\n        message: conferenceCallErrors.modeError,\n        ttl: 0,\n      });\n      return null;\n    }\n    const { sessionId } = conferenceState;\n    let { conference } = conferenceState;\n\n    this.store.dispatch({\n      type: this.actionTypes.bringInConference,\n      conference,\n      sessionId,\n    });\n\n    try {\n      const partyProfile = this._getProfile(webphoneSession.id);\n      await this._client.service.platform()\n        .post(`/account/~/telephony/sessions/${id}/parties/bring-in`, webphoneSession.partyData);\n      const newConference = await this.updateConferenceStatus(id);\n      conference = newConference.conference;\n\n      if (partyProfile) {\n        const conferenceState = this.state.conferences[id];\n        const newParties = ascendSortParties(conferenceState.conference.parties);\n        partyProfile.id = newParties[newParties.length - 1].id;\n      }\n\n      this.store.dispatch({\n        type: this.actionTypes.bringInConferenceSucceeded,\n        conference,\n        sessionId,\n        partyProfile,\n      });\n\n      return id;\n    } catch (e) {\n      this.store.dispatch({\n        type: this.actionTypes.bringInConferenceFailed,\n        message: e.toString()\n      });\n      if (!propagete) {\n        return null;\n      }\n      throw e;\n    }\n  }\n\n  /**\n   * remove a participant from conference.\n   * @param {string} id: conference id\n   * @param {SessionData} partyId: one participant's id of an conference's `parties` list\n   */\n  @proxify\n  async removeFromConference(id, partyId) {\n    this.store.dispatch({\n      type: this.actionTypes.removeFromConference,\n      conference: this.state.conferences[id],\n    });\n\n    try {\n      await this._client.service.platform()\n        .delete(`/account/~/telephony/sessions/${id}/parties/${partyId}`);\n      await this.updateConferenceStatus(id);\n      this.store.dispatch({\n        type: this.actionTypes.removeFromConferenceSucceeded,\n        conference: this.state.conferences[id],\n      });\n    } catch (e) {\n      if (!this._availabilityMonitor || !this._availabilityMonitor.checkIfHAError(e)) {\n        this._alert.warning({\n          message: conferenceCallErrors.removeFromConferenceFailed,\n        });\n      }\n\n      this.store.dispatch({\n        type: this.actionTypes.removeFromConferenceFailed,\n        message: e.toString()\n      });\n    } finally {\n      // eslint-disable-next-line no-unsafe-finally\n      return this.state.conferences[id];\n    }\n  }\n\n  /**\n   * start a conference call, return the session\n   */\n  @proxify\n  async makeConference(propagate = false) {\n    if (!this.ready || !this._connectivityMonitor.connectivity) {\n      this._alert.danger({\n        message: conferenceCallErrors.modeError,\n        ttl: 0,\n      });\n      return null;\n    }\n    if (!this._checkPermission()) {\n      if (!propagate) {\n        this._alert.danger({\n          message: permissionsMessages.insufficientPrivilege,\n          ttl: 0,\n        });\n      }\n\n      return null;\n    }\n    if (!this._callingSettings.callingMode === callingModes.webphone) {\n      if (!propagate) {\n        this._alert.danger({\n          message: conferenceCallErrors.modeError,\n          ttl: 0,\n        });\n      }\n\n      return null;\n    }\n    const conference = await this._makeConference(propagate);\n    return conference;\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  /**\n   * Merge calls to (or create) a conference.\n   * @param {webphone.sessions} webphoneSessions\n   * FIXME: dynamically construct this function during the construction\n   * to avoid `this._webphone` criterias to improve performance ahead of time\n   */\n  @proxify\n  async mergeToConference(webphoneSessions = []) {\n    webphoneSessions = webphoneSessions\n      .filter(session => !!session)\n      .filter(session => !this.isConferenceSession(session.id));\n\n    if (!webphoneSessions.length) {\n      this._alert.warning({\n        message: conferenceCallErrors.bringInFailed,\n      });\n      return;\n    }\n\n    this.store.dispatch({\n      type: this.actionTypes.mergeStart,\n    });\n    let sipInstances;\n    let conferenceId = null;\n\n    if (this._webphone) {\n      /**\n       * Because the concurrency behaviour of the server,\n       * we cannot sure the merging process is over when\n       * the function's procedure has finshed.\n       */\n      sipInstances = webphoneSessions\n        .map(webphoneSession => this._webphone._sessions.get(webphoneSession.id));\n      /**\n       * HACK: we need to preserve the merging session in prevent the glitch of\n       * the call control page.\n       */\n      const sessionIds = webphoneSessions.map(x => x.id);\n      this._webphone.setSessionCaching(sessionIds);\n\n      const pSips = sipInstances.map((instance) => {\n        const p = new Promise((resolve) => {\n          instance.on('terminated', () => {\n            resolve();\n          });\n        });\n        return p;\n      });\n\n      await Promise.all([this._mergeToConference(webphoneSessions), ...pSips])\n        .then(() => {\n          this.store.dispatch({\n            type: this.actionTypes.mergeSucceeded,\n          });\n          const conferenceState = Object.values(this.conferences)[0];\n\n          this._eventEmitter.emit(this.actionTypes.mergeSucceeded, conferenceState);\n        }, () => {\n          const conferenceState = Object.values(this.conferences)[0];\n\n          /**\n           * if create conference successfully but failed to bring-in,\n           *  then terminate the conference.\n           */\n          if (conferenceState && conferenceState.profiles.length < 1) {\n            this.terminateConference(conferenceState.conference.id);\n          }\n          this._alert.warning({\n            message: conferenceCallErrors.bringInFailed,\n          });\n          this.store.dispatch({\n            type: this.actionTypes.mergeFailed,\n          });\n        });\n      this._webphone.clearSessionCaching();\n    } else {\n      try {\n        conferenceId = await this._mergeToConference(webphoneSessions);\n\n        this.store.dispatch({\n          type: this.actionTypes.mergeSucceeded,\n        });\n        this._eventEmitter.emit(this.actionTypes.mergeSucceeded);\n      } catch (e) {\n        const conferenceState = Object.values(this.conferences)[0];\n        /**\n         * if create conference successfully but failed to bring-in,\n         *  then terminate the conference.\n         */\n        if (conferenceState && conferenceState.conference.parties.length < 1) {\n          this.terminateConference(conferenceState.conference.id);\n        }\n\n        if (!this._availabilityMonitor || !this._availabilityMonitor.checkIfHAError(e)) {\n          this._alert.warning({\n            message: conferenceCallErrors.bringInFailed,\n          });\n        }\n      }\n      if (!sipInstances || conferenceId === null) {\n        this.store.dispatch({\n          type: this.actionTypes.mergeFailed,\n        });\n      }\n    }\n  }\n\n  @proxify\n  setMergeParty({ fromSessionId, toSessionId }) {\n    if (fromSessionId) {\n      this.store.dispatch({\n        type: this.actionTypes.updateFromSession,\n        fromSessionId,\n      });\n      return;\n    }\n    this.store.dispatch({\n      type: this.actionTypes.updateToSession,\n      toSessionId,\n    });\n  }\n\n  /**\n   * we need to remove the fromSessionId in mergingPair when the outbound call is hang-up\n   */\n  @proxify\n  closeMergingPair() {\n    if (this.mergingPair.fromSessionId) {\n      return this.store.dispatch({\n        type: this.actionTypes.closeMergingPair,\n      });\n    }\n\n    return null;\n  }\n\n  getOnlinePartyProfiles(id) {\n    const conferenceData = this.conferences[id];\n\n    if (conferenceData) {\n      return ascendSortParties(conferenceData.conference.parties)\n        .reduce((accum, party, idx) => {\n          if (party.status.code.toLowerCase() !== partyStatusCode.disconnected) {\n            // 0 position is the host\n            accum.push({ idx, party });\n          }\n          return accum;\n        }, [])\n        .map(({ idx, party }) => ({ ...party, ...conferenceData.profiles[idx] }))\n        .filter(i => !!i);\n    }\n    return null;\n  }\n\n  getOnlineParties(id) {\n    const conferenceData = this.conferences[id];\n    if (conferenceData) {\n      return conferenceData.conference.parties.filter(\n        p => p.status.code.toLowerCase() !== partyStatusCode.disconnected\n      );\n    }\n    return null;\n  }\n\n  countOnlineParties(id) {\n    const res = this.getOnlineParties(id);\n    return Array.isArray(res) ? res.length : null;\n  }\n\n  isOverload(id) {\n    return this.countOnlineParties(id) >= this.capacity;\n  }\n\n  @proxify\n  async startPollingConferenceStatus(id) {\n    if (this._timers[id] || !this._pulling) {\n      return;\n    }\n\n    await this.updateConferenceStatus(id);\n    this._timers[id] = setTimeout(\n      async () => {\n        await this.updateConferenceStatus(id);\n        this.stopPollingConferenceStatus(id);\n        if (this.conferences[id]) {\n          this.startPollingConferenceStatus(id);\n        }\n      },\n      this._ttl);\n  }\n\n  stopPollingConferenceStatus(id) {\n    clearTimeout(this._timers[id]);\n    delete this._timers[id];\n  }\n\n  openPulling() {\n    this._pulling = true;\n  }\n\n  closePulling() {\n    this._pulling = false;\n  }\n\n  togglePulling() {\n    this._pulling = !this.pulling;\n  }\n\n  setCapatity(capacity = MAXIMUM_CAPACITY) {\n    if (typeof capacity !== 'number') {\n      throw new Error('The capcity must be a number');\n    }\n    this.capacity = capacity;\n    return capacity;\n  }\n\n  setTimeout(timeout = DEFAULT_TIMEOUT) {\n    if (typeof timeout !== 'number') {\n      throw new Error('The timeout must be a number');\n    }\n    this._timout = timeout;\n    return timeout;\n  }\n\n  onMergeSuccess(func, isOnce) {\n    if (isOnce) {\n      this._eventEmitter.once(this.actionTypes.mergeSucceeded, func);\n      return;\n    }\n    this._eventEmitter.on(this.actionTypes.mergeSucceeded, func);\n  }\n\n  removeMergeSuccess(func) {\n    this.off(this.actionTypes.mergeSucceeded, func);\n  }\n\n  @proxify\n  loadConference(conferenceId) {\n    return this.store.dispatch({\n      type: this.actionTypes.updateCurrentConferenceId,\n      conferenceId,\n    });\n  }\n\n  _init() {\n    this.store.dispatch({\n      type: this.actionTypes.initSuccess\n    });\n  }\n\n  async _onStateChange() {\n    if (this._shouldInit()) {\n      this._init();\n    } else if (this._shouldReset()) {\n      this._reset();\n    }\n  }\n\n  _reset() {\n    this.store.dispatch({\n      type: this.actionTypes.resetSuccess\n    });\n  }\n\n  _shouldInit() {\n    return (\n      (this._auth.loggedIn && this._auth.ready) &&\n      this._alert.ready &&\n      this._callingSettings.ready &&\n      this._call.ready &&\n      this._rolesAndPermissions.ready &&\n      this._connectivityMonitor.ready &&\n      (!this._availabilityMonitor || this._availabilityMonitor.ready) &&\n      this.pending\n    );\n  }\n\n  _shouldReset() {\n    return (\n      (\n        (!this._auth.loggedIn || !this._auth.ready)\n        || !this._alert.ready\n        || !this._callingSettings.ready\n        || !this._call.ready\n        || !this._rolesAndPermissions.ready\n        || !this._connectivityMonitor.ready\n        || (!!this._availabilityMonitor && !this._availabilityMonitor.ready)\n      ) &&\n      this.ready\n    );\n  }\n\n  _checkPermission() {\n    if (!this._rolesAndPermissions.hasConferenceCallPermission) {\n      this._alert.danger({\n        message: permissionsMessages.insufficientPrivilege,\n        ttl: 0,\n      });\n      return false;\n    }\n    return true;\n  }\n\n  @proxify\n  _hookConference(conference, session) {\n    ['accepted'].forEach(\n      evt => session.on(\n        evt,\n        () => this.startPollingConferenceStatus(conference.id)\n      )\n    );\n    ['terminated', 'failed', 'rejected'].forEach(\n      evt => session.on(evt, () => {\n        this.store.dispatch({\n          type: this.actionTypes.terminateConferenceSucceeded,\n          conference,\n        });\n        this.stopPollingConferenceStatus(conference.id);\n      })\n    );\n  }\n\n  @proxify\n  async _mergeToConference(webphoneSessions = []) {\n    const conferenceState = Object.values(this.conferences)[0];\n    if (conferenceState) {\n      const conferenceId = conferenceState.conference.id;\n      this.stopPollingConferenceStatus(conferenceId);\n      // for the sake of participants ordering, we can't concurrently bring in the participants\n      for (const webphoneSession of webphoneSessions) {\n        await this.bringInToConference(conferenceId, webphoneSession, true);\n      }\n      if (!this.conferences[conferenceId].profiles.length) {\n        throw new Error('bring-in operations failed, not all intended parties were brought in');\n      }\n      this.startPollingConferenceStatus(conferenceId);\n      return conferenceId;\n    }\n    const { id } = await this.makeConference(true);\n    let confereceAccepted = false;\n    await Promise.race([\n      new Promise((resolve, reject) => {\n        const sipSession = this._webphone._sessions.get(this.conferences[id].sessionId);\n        sipSession.on('accepted', () => {\n          confereceAccepted = true;\n          resolve();\n        });\n        sipSession.on('cancel', () => reject(new Error('conferecing cancel')));\n        sipSession.on('failed', () => reject(new Error('conferecing failed')));\n        sipSession.on('rejected', () => reject(new Error('conferecing rejected')));\n        sipSession.on('terminated', () => reject(new Error('conferecing terminated')));\n      }),\n      new Promise((resolve, reject) => {\n        setTimeout(() => (\n          confereceAccepted ? resolve() : reject(new Error('conferecing timeout')))\n          , this._timout);\n      })\n    ]);\n    await this._mergeToConference(webphoneSessions);\n    return id;\n  }\n\n  @proxify\n  async _makeConference(propagate = false) {\n    try {\n      this.store.dispatch({\n        type: this.actionTypes.makeConference,\n      });\n\n      // TODO: replace with SDK function chaining calls\n      const rawResponse = await this._client.service.platform()\n        .post('/account/~/telephony/conference', {});\n      const response = rawResponse.json();\n      const conference = response.session;\n      const phoneNumber = conference.voiceCallToken;\n      // whether to mutate the session to mark the conference?\n      const session = await this._call.call({\n        phoneNumber,\n        isConference: true,\n      });\n      if (typeof session === 'object' &&\n        Object.prototype.toString.call(session.on).toLowerCase() === '[object function]') {\n        this._hookConference(conference, session);\n\n        this.store.dispatch({\n          type: this.actionTypes.makeConferenceSucceeded,\n          conference,\n          sessionId: session.id,\n          parties: [],\n        });\n      } else {\n        this.store.dispatch({\n          type: this.actionTypes.makeConferenceFailed,\n        });\n      }\n      return conference;\n    } catch (e) {\n      this.store.dispatch({\n        type: this.actionTypes.makeConferenceFailed,\n        message: e.toString()\n      });\n\n      if (!propagate) {\n        this._alert.warning({\n          message: conferenceCallErrors.makeConferenceFailed,\n        });\n        return null;\n      }\n      // need to propagate to out side try...catch block\n      throw e;\n    }\n  }\n\n  _getProfile(sessionId) {\n    const session = this._webphone.sessions.find(session => session.id === sessionId);\n\n    let rcId;\n    let avatarUrl;\n    let calleeType = calleeTypes.unknown;\n    let partyName = (session.direction === callDirections.outbound) ?\n      session.toUserName :\n      session.fromUserName;\n    const partyNumber = (session.direction === callDirections.outbound) ?\n      session.to :\n      session.from;\n\n    let matchedContact = session.contactMatch;\n    if (!matchedContact && this._contactMatcher) {\n      const nameMatches = this._contactMatcher.dataMapping[partyNumber];\n      if (nameMatches && nameMatches.length) {\n        matchedContact = nameMatches[0];\n      }\n    }\n\n    if (matchedContact) {\n      rcId = matchedContact.id;\n      avatarUrl = matchedContact.profileImageUrl;\n      partyName = matchedContact.name;\n      calleeType = calleeTypes.contacts;\n    }\n\n    return {\n      rcId,\n      avatarUrl,\n      partyName,\n      partyNumber,\n      calleeType,\n    };\n  }\n\n  @proxify\n  async parseMergingSessions({ sessionId, sessionIdToMergeWith }) {\n    const session = find(\n      x => x.id === sessionId,\n      this._webphone.sessions\n    );\n\n    const sessionToMergeWith = find(\n      x => x.id === (sessionIdToMergeWith || this.mergingPair.fromSessionId),\n      this._webphone.sessions\n    );\n\n    const webphoneSessions = sessionToMergeWith\n      ? [sessionToMergeWith, session]\n      : [session];\n\n    for (const session of webphoneSessions) {\n      if (!this.validateCallRecording(session)) {\n        return null;\n      }\n    }\n\n    const conferenceState = Object.values(this.conferences)[0];\n    if (conferenceState) {\n      const conferenceSession = find(\n        x => x.id === conferenceState.sessionId,\n        this._webphone.sessions\n      );\n      if (!this.validateCallRecording(conferenceSession)) {\n        return null;\n      }\n    }\n\n    return {\n      session,\n      sessionToMergeWith,\n    };\n  }\n\n  @proxify\n  async mergeSessions({ session, sessionToMergeWith }) {\n    this.setMergeParty({\n      toSessionId: session.id,\n    });\n\n    const webphoneSessions = sessionToMergeWith\n      ? [sessionToMergeWith, session]\n      : [session];\n    await this.mergeToConference(webphoneSessions);\n\n    const conferenceData = Object.values(this.conferences)[0];\n    if (!conferenceData) {\n      await this._webphone.resume(session.id);\n      return null;\n    }\n    const currentConferenceSession = find(\n      x => x.id === conferenceData.sessionId,\n      this._webphone.sessions\n    );\n    const isCurrentConferenceOnhold = currentConferenceSession.isOnHold;\n\n    if (isCurrentConferenceOnhold) {\n      this._webphone.resume(conferenceData.sessionId);\n    }\n\n    return conferenceData;\n  }\n\n  validateCallRecording(session) {\n    if (isRecording(session)) {\n      this._alert.warning({\n        message: conferenceCallErrors.callIsRecording,\n      });\n      return false;\n    }\n    return true;\n  }\n\n  /*\n  * User action track dispatchs\n  * */\n\n  participantListClickHangupTrack() {\n    this.store.dispatch({\n      type: this.actionTypes.participantListClickHangupTrack\n    });\n  }\n\n  removeParticipantClickCancelTrack() {\n    this.store.dispatch({\n      type: this.actionTypes.removeParticipantClickCancelTrack\n    });\n  }\n\n  removeParticipantClickRemoveTrack() {\n    this.store.dispatch({\n      type: this.actionTypes.removeParticipantClickRemoveTrack\n    });\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get conferences() {\n    return this.state.conferences;\n  }\n\n  get conferenceCallStatus() {\n    return this.state.conferenceCallStatus;\n  }\n\n  get isMerging() {\n    return this.state.isMerging;\n  }\n\n  get mergingPair() {\n    return this.state.mergingPair;\n  }\n\n  get currentConferenceId() {\n    return this.state.currentConferenceId;\n  }\n\n  @selector\n  lastCallInfo = [\n    () => this._webphone.sessions,\n    () => this.mergingPair.fromSessionId,\n    () => this.partyProfiles,\n    (sessions, fromSessionId, partyProfiles) => {\n      if (!fromSessionId) {\n        _lastCallInfo = null;\n        return _lastCallInfo;\n      }\n\n      let sessionName;\n      let sessionNumber;\n      let sessionStatus;\n      let matchedContact;\n      const fromSession = sessions.find(session => session.id === fromSessionId);\n      if (fromSession) {\n        sessionName = (fromSession.direction === callDirections.outbound) ?\n          fromSession.toUserName :\n          fromSession.fromUserName;\n        sessionNumber = (fromSession.direction === callDirections.outbound) ?\n          fromSession.to :\n          fromSession.from;\n        sessionStatus = fromSession.callStatus;\n        matchedContact = fromSession.contactMatch;\n        if (!matchedContact && this._contactMatcher) {\n          const nameMatches = this._contactMatcher.dataMapping[sessionNumber];\n          if (nameMatches && nameMatches.length) {\n            matchedContact = nameMatches[0];\n          }\n        }\n      }\n\n      let lastCalleeType;\n      if (fromSession) {\n        if (matchedContact) {\n          lastCalleeType = calleeTypes.contacts;\n        } else if (this.isConferenceSession(fromSession.id)) {\n          lastCalleeType = calleeTypes.conference;\n        } else {\n          lastCalleeType = calleeTypes.unknown;\n        }\n      } else if (\n        _fromSessionId === fromSessionId\n        && _lastCallInfo && _lastCallInfo.calleeType\n      ) {\n        _lastCallInfo = {\n          ..._lastCallInfo,\n          status: sessionStatusEnum.finished,\n        };\n        return _lastCallInfo;\n      } else {\n        return {\n          calleeType: calleeTypes.unknown,\n        };\n      }\n\n      let partiesAvatarUrls = null;\n      if (lastCalleeType === calleeTypes.conference) {\n        partiesAvatarUrls = (partyProfiles || []).map(profile => profile.avatarUrl);\n      }\n      switch (lastCalleeType) {\n        case calleeTypes.conference:\n          _lastCallInfo = {\n            calleeType: calleeTypes.conference,\n            avatarUrl: partiesAvatarUrls[0],\n            extraNum: partiesAvatarUrls.length - 1,\n            name: null,\n            phoneNumber: null,\n            status: sessionStatus,\n            lastCallContact: null,\n          };\n          break;\n        case calleeTypes.contacts:\n          _lastCallInfo = {\n            calleeType: calleeTypes.contacts,\n            avatarUrl: matchedContact.profileImageUrl,\n            name: matchedContact.name,\n            status: sessionStatus,\n            phoneNumber: sessionNumber,\n            extraNum: 0,\n            lastCallContact: matchedContact,\n          };\n          break;\n        default:\n          _lastCallInfo = {\n            calleeType: calleeTypes.unknown,\n            avatarUrl: null,\n            name: sessionName,\n            status: sessionStatus,\n            phoneNumber: sessionNumber,\n            extraNum: 0,\n            lastCallContact: null,\n          };\n      }\n\n      _fromSessionId = fromSessionId;\n      return _lastCallInfo;\n    },\n  ]\n\n  @selector\n  partyProfiles = [\n    () => this.currentConferenceId,\n    () => this.conferences,\n    (currentConferenceId, conferences) => {\n      const conferenceData = conferences && conferences[currentConferenceId];\n      if (!conferenceData) {\n        return [];\n      }\n      return this.getOnlinePartyProfiles(currentConferenceId);\n    },\n  ]\n}\n"],"file":"index.js"}