{"version":3,"sources":["lib/proxy/getProxyServer.js"],"names":["getProxyServer","createTarget","transport","options","actionTypes","baseActionTypes","_target","_getState","state","target","subModule","Object","prototype","hasOwnProperty","RcModule","defineProperty","configurable","enumerable","get","_transport","ensureExist","_reducer","moduleReducer","reducer","prefix","on","events","request","requestId","payload","type","functionPath","args","actionNumber","execute","sync","split","slice","pathTokens","fnName","pop","forEach","token","result","response","error","Error"],"mappings":"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","sourcesContent":["import RcModule from '../RcModule';\nimport baseActionTypes from './baseActionTypes';\nimport getProxyServerReducer from './getProxyServerReducer';\nimport ensureExist from '../ensureExist';\n\nexport default function getProxyServer(createTarget) {\n  return class extends RcModule {\n    constructor({ transport, ...options }) {\n      super({\n        ...options,\n        actionTypes: baseActionTypes,\n      });\n      this._target = createTarget({\n        ...options,\n      });\n      this._target._getState = () => this.state.target;\n\n      for (const subModule in this._target) {\n        if (\n          this._target::Object.prototype.hasOwnProperty(subModule) &&\n            this._target[subModule] instanceof RcModule\n        ) {\n          Object.defineProperty(this, subModule, {\n            configurable: false,\n            enumerable: true,\n            get() {\n              return this._target[subModule];\n            },\n          });\n        }\n      }\n\n      this._transport = this::ensureExist(transport, 'transport');\n      this._reducer = getProxyServerReducer({\n        moduleReducer: this._target.reducer,\n        transport,\n        prefix: this.prefix,\n      });\n\n      transport.on(\n        transport.events.request,\n        async ({\n          requestId,\n          payload: {\n            type,\n            functionPath,\n            args,\n            actionNumber\n          },\n        }) => {\n          switch (type) {\n            case this.actionTypes.execute: {\n              const [...pathTokens] = functionPath.split('.').slice(1);\n              const fnName = pathTokens.pop();\n              let target = this._target;\n              pathTokens.forEach((token) => {\n                target = target[token];\n              });\n              try {\n                const result = await target[fnName](...args);\n                transport.response({\n                  requestId,\n                  result,\n                });\n              } catch (error) {\n                transport.response({\n                  requestId,\n                  error,\n                });\n              }\n            }\n              break;\n            case this.actionTypes.sync: {\n              if (actionNumber !== this.state.actionNumber) {\n                transport.response({\n                  requestId,\n                  result: this.state,\n                });\n              } else {\n                transport.response({\n                  requestId,\n                  error: new Error('State is already up to date.'),\n                });\n              }\n              break;\n            }\n            default:\n              transport.response({\n                requestId,\n                error: new Error(`Invalid request type '${type}'.`)\n              });\n              break;\n          }\n        },\n      );\n    }\n  };\n}\n"],"file":"getProxyServer.js"}